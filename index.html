<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Force Layout Example 2</title>
    <style>

        .node {
        }

        .link {
            stroke: #777;
            stroke-width: 3px;
        }

    </style>
</head>
<body>
    <h1>OCN LISP Demonstration</h1>
    <hr> </hr>
    <script src='http://d3js.org/d3.v3.min.js'></script>
    <script>


        var width = 900,
        height = 700;

        var iconsize = 80;

        var fill = d3.scale.category10();

        var svg = d3.select('body').append('svg')
        .attr('width', width)
        .attr('height', height);

        var force = d3.layout.force()
        .charge(-3200)
        .linkDistance(120)
        .size([width, height]);

        // setTimeout(function() {
        //     nodes.splice(4, 4); // remove b
        //     links.shift(); // remove a-b
        //     links.pop(); // remove b-c
        //     start();
        // }, 3000);

        // setTimeout(function() {
        //     var a = nodes[1], b = {id: "laptop"}, c = nodes[4];
        //     nodes.push(b);
        //     links.push({source: a, target: b}, {source: b, target: c});
        //     start();
        // }, 6000);
        var nodes = [];
            links = [];

        var link = svg.selectAll('.link');
        var node = svg.selectAll('.node');

        function update(file) {
            // console.log('force.links:');
            // console.log(force.links());
            // console.log('force.nodes:');
            // console.log(force.nodes());
            // console.log(link);
            d3.json(file, function(error, graph) {
                var lnk = force.links();
                var glnk = graph.link;
                console.log(graph.link);
                graph.link.forEach(function(curlink) { 
                    if (curlink.source == 4) {
                        console.log("laptop entry")
                        if (curlink.target == lnk[0].target) {
                            console.log("laptop stays");
                        } else {
                            console.log("move laptop");
                            lnk[0].target = (force.nodes())[curlink.target];
                        }
                     }
                    if (curlink.source == 5) {
                        console.log("vm entry")
                if (curlink.target == lnk[1].target) {
                    console.log("vm stays");
                } else {
                    console.log("move vm");
                    console.log("move to: " + graph.link[1].target);
                    lnk[1].target = (force.nodes())[curlink.target];
                }}});

                });
            // console.log('new link');
            // console.log(link);

            force.start();
        }

        setTimeout(function() {
            update('data4.json');
        }, 5000);
        setTimeout(function() {
            update('data5.json');
        }, 8000);
        setTimeout(function() {
            update('data6.json');
        }, 11000);

        d3.json('data2.json', function(error, graph) {
            nodes = graph.nodes;
            links = graph.links;
            force
            .nodes(nodes)
            .links(links)
            .start();

            link = svg.selectAll('.link')
            .data(links)
            .enter().append('line')
            .attr('class', 'link');

            // (force.links())[0].attr("stroke", "blue");
            // link[1].attr("stroke", "blue");

            node = svg.selectAll('.node')
            .data(nodes)
            .enter().append("g")
            .attr('class', 'node')
            .call(force.drag);

            // console.log("image");
            node.append("image")
                .attr("xlink:href", function(d) {return d.img;})
                .attr("x", function(d) {return -d.size / 2;})
                .attr("y", function(d) {return -d.size / 2;})
                .attr("width", function(d) {return d.size;})
                .attr("height", function(d) {return d.size;});

            node.append("text")
            .attr("x", -30)
            .attr("dy", 50)
            .attr("fill", function(d) {return d.color;})
            .attr("font-family", "sans-serif")
            .text(function(d) {return d.ip;});

        });


        force.on("tick", function() {
            nodes[0].x = width / 4;
            nodes[0].y = height / 4;
            nodes[3].x = width / 4 * 3;
            nodes[3].y = height / 4;
            nodes[2].x = width / 4;
            nodes[2].y = height / 4 * 3;
            nodes[1].x = width / 4 * 3;
            nodes[1].y = height / 4 * 3;

            nodes[6].x = width / 2;
            nodes[6].y = height / 2;
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")";});
        });

</script>
</body>
</html>

